<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Washing Process Report</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background-color: #f4f4f4;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column; /* Changed from row to column */
    height: 130vh;
}

.container {
    max-width: 800px; 
    width: 100%;
    margin: 20px auto;
    padding: 10px;
    background: white;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    max-height: 90vh; /* Adjust the height for scrollable effect */
}

.card-body {
    width: 100%;
    max-height: 90vh;
}

h2 {
    background: #007BFF;
    color: white;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: left;
}

th {
    background-color: #007BFF;
    color: white;
}

tr:nth-child(even) {
    background-color: #f8f9fa;
}

button {
    padding: 10px 15px;
    margin: 10px;
    border: none;
    background-color: #007BFF;
    color: white;
    font-size: 16px;
    cursor: pointer;
    border-radius: 5px;
}

button:hover {
    background-color: #0056b3;
}

.excel-btn { 
    background: green; 
    color: white; 
    border: none; 
}

.pdf-btn { 
    background: red; 
    color: white; 
    border: none; 
}

.back-btn { 
    background: gray; 
    color: white; 
    border: none; 
}

/* Add new modal styles */
.modal-dialog {
    max-width: 80%;
    margin: 1.75rem auto;
}

.modal-content {
    height: 90vh;
    overflow-y: auto;
}

.modal iframe {
    width: 100%;
    height: calc(90vh - 120px);
    border: none;
}

    </style>

</head>
<body> 
    <div class="card" style="width: 750px; height: 960px;" id="dataForm">
        <div class="card-body">
            <h2 class="mb-4">Washing Load Records</h2>
            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>#</th>
                    <th>Operator</th>
                    <th>Date</th>
                    <th>Trolley Number</th>
                    <th>Load Number</th>
                    <th>Equipment</th>
                    <th>Set Time</th>
                    <th>Program</th>
                    <th>Linen Type</th>
                    <th>Other Linen</th>
                    <th>Linen Size</th>
                    <th>Quantity</th>
                    <th>Detergent</th>
                    <th>Dosage</th>
                    <th>Mix Type</th>
                    <th>Before Wash (kg)</th>
                    <th>After Wash (kg)</th>
                    <th>RMC</th>
                  </tr>
                </thead>
                    <tbody id="tableBody">
                        <!-- Data will be injected here -->
                    </tbody>
              </table>
            </div>
        </div>
        <button type="button" class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#washProcessModal">Add Load</button>

<div class="card">
    <div class="card-body">
    <h2>Electric Submetering Data</h2>
    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Equipment</th>
                <th>Start Reading (kWh)</th>
                <th>End Reading (kWh)</th>
                <th>Total kWh Used</th>
                <th>Estimated Cost (â‚±)</th>
            </tr>
        </thead>
        <tbody id="eSubDataWasher">

        </tbody>

        <!-- <tr>
            <td id="outEquip"></td>
            <td id="outStartReadings"></td>
            <td id="outEndReadings"></td>
            <td id="outTotalUseds"></td>
            <td id="outCosts"></td>
        </tr> -->
    </table>        
    </div>
    <button type="button" class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#energyConsModal">Add Readings</button>

</div>
<div class="card">
   <table class="table-dark table-striped">
    <h2>Water Submetering System</h2>

    <tbody id="outputContainer">

    </tbody>
   </table> 

    <table class="table table-bordered table-striped">
        <h2>Water Submetering Overall Total</h2>
        <thead class="table-dark"> 
            <tr>
                <th>Overall Total Consumption (mÂ³)</th>
                <th>Overall Total Cost (â‚±)</th>
            </tr>
        </thead>

        <tr>
            <tbody>
                <td id="sumUsed">

                </td>
                <td id="sumCost">
    
                </td>
            </tbody>
 
        </tr>
     </table>
  

        <button type="button" class="btn btn-primary btn-block" data-bs-toggle="modal" data-bs-target="#waterConsModal">Add Readings</button>
</div>
        <button class="excel-btn" onclick="exportToExcel()">Download as Excel</button>
        <button class="pdf-btn" onclick="exportToPDF()">Download as PDF</button>
        <button class="back-btn" onclick="clearAllDataAndGoHome()">Go to HomePage</button>
</div>
</div>

    <script>

function renderElectricSubmeteringData(){
    const eSubData = document.getElementById('eSubDataWasher');
    const eStoreData = JSON.parse(localStorage.getItem('eData_washer') || '[]');

    eSubData.innerHTML = '';  // Clear the table before rendering new data

    if (eStoreData.length === 0) {
        eSubData.innerHTML = '<tr><td colspan="5" class="text-center">No data available.</td></tr>';
    } else {
        eStoreData.forEach((item, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.equip}</td>
                <td>${item.startRead}</td>
                <td>${item.endRead}</td>
                <td>${item.totalUsed}</td>
                <td>${item.estimatedCost}</td>
                <td>
                     <button class="btn btn-sm btn-danger" onclick="deleteElectricData(${index})">Delete</button>
                    <button class="btn btn-sm btn-warning" onclick="editElectricData(${index})">Edit</button>

                </td>
            `;
            eSubData.appendChild(row); // Add the row to the table
        });
    }
}
function deleteElectricData(index) {
    const eStoreData = JSON.parse(localStorage.getItem('eData_washer') || '[]');
    eStoreData.splice(index, 1);
    localStorage.setItem('eData_washer', JSON.stringify(eStoreData));
    renderElectricSubmeteringData();
}
function editElectricData(index) {
    window.location.href = `energy_cons.html?editIndex=${index}`;
}
// Update Electric Submetering Data
function updateElectricSubmeteringData(updatedData, editIndex = null) {
    // Update the electric submetering data
    if (editIndex !== null && eStoreData[editIndex]) {
        // âœ… Replace existing entry if in edit mode
        eStoreData[editIndex] = updatedData;
    } else {
        // âž• Otherwise, push new entry
        eStoreData.push(updatedData);
    }
    localStorage.setItem('eData_washer', JSON.stringify(eStoreData));
    renderElectricSubmeteringData();
}

renderElectricSubmeteringData();


function renderWashingData() {
    const storedData = JSON.parse(localStorage.getItem("loadData")) || [];
    const tableBody = document.getElementById("tableBody");
    tableBody.innerHTML = ""; // Clear old rows first

    if (storedData.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="18" class="text-center">No data available</td>`;
        tableBody.appendChild(row);
    } else {
        storedData.forEach((load, index) => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${load.operator_name}</td>
                <td>${load.date}</td>
                <td>${load.trolley_number}</td>
                <td>${load.load_number}</td>
                <td>${load.equipment}</td>
                <td>${load.set_time}</td>
                <td>${load.program}</td>
                <td>${load.linen_type}</td>
                <td>${load.other_linen}</td>
                <td>${load.linen_sizes}</td>
                <td>${load.quantity}</td>
                <td>${load.detergent}</td>
                <td>${load.dosage}</td>
                <td>${load.mixType}</td>
                <td>${load.bfr_wash}</td>
                <td>${load.aftr_wash}</td>
                <td>${load.rmc}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteWashingData(${index})">Delete</button>
                    <button class="btn btn-sm btn-warning" onclick="editWashingData(${index})">Edit</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
}

function editWashingData(index) {
    window.location.href = `wash_proc.html?editIndex=${index}`;
}

function deleteWashingData(index) {
    const storeData = JSON.parse(localStorage.getItem('loadData') || '[]');
    storeData.splice(index, 1);
    localStorage.setItem('loadData', JSON.stringify(storeData));
    renderWashingData(); // Refresh the table after deletion
}

function updateWashingData(updatedData, index = null) {
    const storeData = JSON.parse(localStorage.getItem('loadData') || '[]');

    if (index !== null && index >= 0) {
        storeData[index] = updatedData; // Update existing data
    } else {
        storeData.push(updatedData); // Add new entry
    }

    localStorage.setItem('loadData', JSON.stringify(storeData));
    renderWashingData();
}

// Call this on page load
renderWashingData();


            // Refresh page when modal is closed to update data
            const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            modal.addEventListener('hidden.bs.modal', function () {
                location.reload();
                
            });
        });
        

        //clear data when Go to HomePage got clicked
        function clearAllDataAndGoHome() {
            try{
                localStorage.clear();
                window.location.href = '../index.html';
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        }
        // Function to update display
        function updateDisplay() {
            try {
                console.log("Updating display...");
                console.log("Current localStorage data:", JSON.stringify(localStorage, null, 2));

                // Update all displayed values from localStorage
                const elements = {
                    "outOperator": "operator_name",
                    "outDate": "date",
                    "outLoad_number": "load_number",
                    "outTrolley_number": "trolley_number",
                    "outEquipment": "equipment",
                    "outSet_time": "set_time",
                    "outProgram": "program",
                    "outLinen_sizes": "linen_sizes",
                    "outQuantity": "quantity",
                    "outBfr_wash": "bfr_wash",
                    "outAftr_wash": "aftr_wash",
                    "outRMC": "rmc_total",
                    "outStartReadings": "start_reads",
                    "outEndReadings": "end_reads",
                    "outTotalUseds": "total_used",
                    "outCosts": "cost",
                    "outDetergent": "detergent",
                    "outMixType": "mixType",
                    "outDosage": "dosage",
                };

                // Update each element with debug logging
                Object.entries(elements).forEach(([elementId, storageKey]) => {
                    const element = document.getElementById(elementId);
                    const value = localStorage.getItem(storageKey);
                    console.log(`Updating ${elementId} with ${storageKey}:`, value);
                    if (element) {
                        element.textContent = value || "N/A";
                    } else {
                        console.warn(`Element not found: ${elementId}`);
                    }
                });

                // Handle special cases
                handleLinenType();
                handleMixtureType();
                updateWaterReadings();
            } catch (error) {
                console.error("Error in updateDisplay:", error);
            }
        }

        // Function to handle linen type display
        function handleLinenType() {
            try {
                let linenType = localStorage.getItem("linen-type");
                let otherLinen = localStorage.getItem("other-linen");
                console.log("Linen type:", linenType, "Other linen:", otherLinen);

                let linenTypeElement = document.getElementById("outLinen-type");
                let otherLinenElement = document.getElementById("outOtherLinen");
                
                if (linenType && linenType.toLowerCase() === "others" && otherLinen) {
                    if (linenTypeElement) linenTypeElement.textContent = otherLinen;
                    if (otherLinenElement) otherLinenElement.style.display = "none";
                } else {
                    if (linenTypeElement) linenTypeElement.textContent = linenType || "N/A";
                    if (otherLinenElement) otherLinenElement.style.display = "none";
                }
            } catch (error) {
                console.error("Error in handleLinenType:", error);
            }
        }

        // Function to handle mixture type display
        function handleMixtureType() {
            try {
                let mixType = localStorage.getItem("mixType");
                let dosage = localStorage.getItem("dosage");
                console.log("Mix type:", mixType, "Dosage:", dosage);
                
                if (mixType && dosage) {
                    if (mixType.toLowerCase() === "liquid") {
                        dosage += "mL";
                    } else if (mixType.toLowerCase() === "powdered") {
                        dosage += "mG";
                    }
                } else {
                    mixType = "N/A";
                    dosage = "N/A";
                }
                
                const mixTypeElement = document.getElementById("outMixType");
                const dosageElement = document.getElementById("outDosage");
                
                if (mixTypeElement) mixTypeElement.textContent = mixType;
                if (dosageElement) dosageElement.textContent = dosage;
            } catch (error) {
                console.error("Error in handleMixtureType:", error);
            }
        }

        function updateWaterReadings() {
    try {
        console.log("Updating water readings...");
        let waterReadings = JSON.parse(localStorage.getItem("waterReadings") || "[]");
        console.log("Water readings from localStorage:", waterReadings);

        let outputContainer = document.getElementById("outputContainer");
        if (!outputContainer) {
            console.error("Output container not found");
            return;
        }
        outputContainer.innerHTML = '';

        if (waterReadings.length > 0) {
            let groupedData = {};
            waterReadings.forEach(reading => {
                if (!groupedData[reading.waterType]) {
                    groupedData[reading.waterType] = [];
                }
                groupedData[reading.waterType].push(reading);
            });

            Object.keys(groupedData).forEach(waterType => {
                let programTable = document.createElement("div");
                programTable.innerHTML = `
                    <table border="1">
                        <thead>
                            <tr>
                                <th>Equipment</th>
                                <th>Temperature</th>
                                <th>Start Reading (mÂ³)</th>
                                <th>End Reading (mÂ³)</th>
                                <th>Total Water Used (mÂ³)</th>
                                <th>Estimated Cost (â‚±)</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody_${waterType.replace(/\s+/g, '_')}">
                        </tbody>
                    </table>
                `;
                outputContainer.appendChild(programTable);

                let tableBody = document.getElementById(`tableBody_${waterType.replace(/\s+/g, '_')}`);
                if (tableBody) {
                    groupedData[waterType].forEach(reading => {
                        console.log("Reading:", reading); // ðŸ‘ˆ add this line
                        let row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${reading.equipment || "N/A"}</td>
                            <td>${reading.temp || "N/A"}</td>
                            <td>${reading.startRead || "N/A"}</td>
                            <td>${reading.endRead || "N/A"}</td>
                            <td>${reading.totalUsed || "N/A"}</td>
                            <td>${reading.cost || "N/A"}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    outputContainer.innerHTML = '';
                }
            });

            let totalUsed = waterReadings.reduce((sum, reading) => sum + (parseFloat(reading.totalUsed) || 0), 0);
            let totalCost = waterReadings.reduce((sum, reading) => sum + (parseFloat(reading.cost) || 0), 0);

            const sumUsedElement = document.getElementById("sumUsed");
            const sumCostElement = document.getElementById("sumCost");

            if (sumUsedElement) sumUsedElement.textContent = totalUsed.toFixed(2);
            if (sumCostElement) sumCostElement.textContent = totalCost.toFixed(2);

            localStorage.setItem("sumUsed", totalUsed.toFixed(2));
            localStorage.setItem("sumCost", totalCost.toFixed(2));
        } else {
            outputContainer.innerHTML = '';
        }
    } catch (error) {
        console.error("Error updating water readings:", error);
        console.error("Error details:", error.message);
        console.error("Error stack:", error.stack);
    }
}


        // Modal event handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded");
            
            // Clear any existing event listeners
            const existingModals = document.querySelectorAll('.modal');
            existingModals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.dispose();
                }
            });

            const modals = {
                'washProcessModal': { url: 'wash_proc.html', title: 'Edit Washing Process' },
                'energyConsModal': { url: 'energy_cons.html', title: 'Edit Energy Consumption' },
                'waterConsModal': { url: 'water_cons.html', title: 'Edit Water Consumption' }
            };

            Object.entries(modals).forEach(([modalId, config]) => {
                const modal = document.getElementById(modalId);
                if (!modal) {
                    console.warn(`Modal not found: ${modalId}`);
                    return;
                }

                // Create iframe when modal is shown
                modal.addEventListener('show.bs.modal', function() {
                    console.log(`Showing modal: ${modalId}`);
                    const modalBody = this.querySelector('.modal-body');
                    const timestamp = new Date().getTime();
                    modalBody.innerHTML = `<iframe src="${config.url}?t=${timestamp}" style="width: 100%; height: 80vh; border: none;"></iframe>`;
                    
                    const iframe = modalBody.querySelector('iframe');
                    iframe.addEventListener('load', function() {
                        try {
                            console.log(`Iframe loaded for ${modalId}`);
                            const iframeDoc = this.contentWindow.document;
                            const iframeWin = this.contentWindow;

                            // Hide navigation and adjust padding
                            const navContainer = iframeDoc.querySelector('.nav-container');
                            if (navContainer) {
                                navContainer.style.display = 'none';
                                iframeDoc.body.style.paddingTop = '20px';
                            }

                            // Wait for the form to be fully loaded
                            setTimeout(() => {
                                try {
                                    console.log("Loading form data...");
                                    // Load existing data into form fields
                                    const inputs = iframeDoc.querySelectorAll('input, select');
                                    inputs.forEach(input => {
                                        let value;
                                        if (modalId === 'energyConsModal') {
                                            value = localStorage.getItem(input.id) || '';
                                            if (input.id === 'costing') {
                                                value = localStorage.getItem('costing') || '';
                                            }
                                            console.log(`Loading energy data for ${input.id}:`, value);
                                        } else if (modalId === 'waterConsModal') {
                                            // For water consumption, we need to handle the readings array
                                            const waterReadings = JSON.parse(localStorage.getItem("waterReadings") || "[]");
                                            if (waterReadings.length > 0) {
                                                // Find the matching reading for this input
                                                const reading = waterReadings.find(r => r.id === input.id);
                                                value = reading ? reading[input.name] : '';
                                            }
                                            console.log(`Loading water data for ${input.id}:`, value);
                                        } else {
                                            value = localStorage.getItem(input.id) || '';
                                        }
                                        
                                        if (value) {
                                            if (input.type === 'radio') {
                                                if (input.value === value) input.checked = true;
                                            } else {
                                                input.value = value;
                                            }
                                        }
                                    });

                                    // Modify the Next/Submit button
                                    const nextButton = iframeDoc.querySelector('#nextBtn, button[type="submit"]');
                                    if (nextButton) {
                                        nextButton.textContent = 'Done Editing';
                                        nextButton.onclick = function(e) {
                                            e.preventDefault();
                                            console.log("Saving form data...");
                                            
                                            if (modalId === 'energyConsModal') {
                                                // Special handling for energy consumption
                                                const startRead = iframeDoc.getElementById('start_reads').value;
                                                const endRead = iframeDoc.getElementById('end_reads').value;
                                                const costing = iframeDoc.getElementById('costing').value;

                                                if (startRead && endRead && costing) {
                                                    const totalUsed = Math.max(0, parseFloat(endRead) - parseFloat(startRead));
                                                    const estimatedCost = totalUsed * parseFloat(costing);

                                                    localStorage.setItem('start_reads', startRead);
                                                    localStorage.setItem('end_reads', endRead);
                                                    localStorage.setItem('costing', costing);
                                                    localStorage.setItem('total_used', totalUsed.toFixed(4));
                                                    localStorage.setItem('cost', 'â‚±' + estimatedCost.toFixed(4));
                                                }
                                            } else if (modalId === 'waterConsModal') {
                                                // For water consumption, call the iframe's submitData function
                                                if (typeof iframeWin.submitData === 'function') {
                                                    iframeWin.submitData();
                                                }
                                            } else {
                                                // Regular form data saving
                                                const formInputs = iframeDoc.querySelectorAll('input, select');
                                                formInputs.forEach(input => {
                                                    if (input.type === 'radio') {
                                                        if (input.checked) {
                                                            localStorage.setItem(input.name, input.value);
                                                        }
                                                    } else {
                                                        localStorage.setItem(input.id, input.value);
                                                    }
                                                });
                                            }

                                            const modalInstance = bootstrap.Modal.getInstance(modal);
                                            modalInstance.hide();
                                            updateDisplay();
                                        };
                                    }

                                    // Hide back button
                                    const backButton = iframeDoc.querySelector('#back_bnt');
                                    if (backButton) {
                                        backButton.style.display = 'none';
                                    }

                                    // For water consumption, load existing data
                                    if (modalId === 'waterConsModal') {
                                        const waterReadings = JSON.parse(localStorage.getItem('waterReadings') || '[]');
                                        if (waterReadings.length > 0 && typeof iframeWin.loadExistingData === 'function') {
                                            iframeWin.loadExistingData(waterReadings);
                                        }
                                    }

                                    // Add input event listeners for real-time calculations
                                    inputs.forEach(input => {
                                        input.addEventListener('input', function() {
                                            if (typeof iframeWin.calculate === 'function') {
                                                iframeWin.calculate();
                                            }
                                        });
                                    });

                                    // Trigger initial calculation if data exists
                                    if (typeof iframeWin.calculate === 'function') {
                                        iframeWin.calculate();
                                    }

                                } catch (e) {
                                    console.error('Error setting up form:', e);
                                    console.error('Error details:', e.message);
                                    console.error('Error stack:', e.stack);
                                }
                            }, 500);

                        } catch (e) {
                            console.error('Error modifying iframe content:', e);
                            console.error('Error details:', e.message);
                            console.error('Error stack:', e.stack);
                        }
                    });
                });

                // Update display when modal is hidden
                modal.addEventListener('hidden.bs.modal', function() {
                    console.log(`Modal hidden: ${modalId}`);
                    setTimeout(() => {
                        updateDisplay();
                    }, 100);
                });
            });

            // Initial display update
            updateDisplay();
        });

        // Retrieve and display data
        document.getElementById("outOperator").textContent = localStorage.getItem("operator_name") || "N/A";
        document.getElementById("outDate").textContent = localStorage.getItem("date") || "N/A";
        document.getElementById("outLoad_number").textContent = localStorage.getItem("load_number") || "N/A";
        document.getElementById("outTrolley_number").textContent = localStorage.getItem("trolley_number") || "N/A";
        document.getElementById("outEquipment").textContent = localStorage.getItem("equipment") || "N/A";
        document.getElementById("outSet_time").textContent = localStorage.getItem("set_time") || "N/A";
        document.getElementById("outProgram").textContent = localStorage.getItem("program") || "N/A";
        document.addEventListener("DOMContentLoaded", function () {
        let linenType = localStorage.getItem("linen-type") || "N/A";
        let otherLinen = localStorage.getItem("other-linen") || "";
        let linenTypeElement = document.getElementById("outLinen-type");
        let otherLinenElement = document.getElementById("outOtherLinen");
    
        if (linenType.toLowerCase() === "others" && otherLinen) {
            linenTypeElement.textContent = otherLinen;
            otherLinenElement.style.display = "none";
        } else {
            linenTypeElement.textContent = linenType;
            otherLinenElement.style.display = "none";
        }
    });
        document.getElementById("outLinen_sizes").textContent = localStorage.getItem("linen_sizes") || "N/A";
        document.getElementById("outQuantity").textContent = localStorage.getItem("quantity") || "N/A";
        document.getElementById("outBfr_wash").textContent = localStorage.getItem("bfr_wash") || "N/A";
        document.getElementById("outAftr_wash").textContent = localStorage.getItem("aftr_wash") || "N/A";
        document.getElementById("outRMC").textContent = localStorage.getItem("rmc_total") || "N/A"; 

        // Retrieve and display electric metering data from localStorage
        document.getElementById("outStartReadings").textContent = localStorage.getItem("start_reads") ? localStorage.getItem("start_reads") + " kWh" : "N/A";
        document.getElementById("outEndReadings").textContent = localStorage.getItem("end_reads") ? localStorage.getItem("end_reads") + " kWh" : "N/A";
        document.getElementById("outTotalUseds").textContent = localStorage.getItem("total_used") ? localStorage.getItem("total_used") + " kWh" : "N/A";
        document.getElementById("outCosts").textContent = localStorage.getItem("cost") ? localStorage.getItem("cost") : "N/A";

        document.getElementById("outDetergent").textContent = localStorage.getItem("detergent") || "N/A";
        document.addEventListener("DOMContentLoaded", function () {
    let mixType = localStorage.getItem("mixType") || "N/A";
    let dosage = localStorage.getItem("dosage") || "N/A";

    if (mixType.toLowerCase() === "liquid") {
        dosage += "mL";
    } else if (mixType.toLowerCase() === "powdered") {
        dosage += "mG";
    }

    document.getElementById("outMixType").textContent = mixType;
    document.getElementById("outDosage").textContent = dosage;
});


    document.getElementById("currentDate").textContent = new Date().toLocaleString();

    function exportToExcel() {
    let tables = document.querySelectorAll("table");
    if (tables.length === 0) {
        alert("No table data found to export.");
        return;
    }

    let wb = XLSX.utils.book_new();
    let ws_data = [];

    ws_data.push(["Laundry & Utility Data Report"]);
    ws_data.push(["Generated on:", new Date().toLocaleString()]);
    ws_data.push([]);

    tables.forEach((table) => {
        let title = table.previousElementSibling?.innerText || "Untitled Table";
        ws_data.push([title]);
        ws_data.push([]);

        let rows = table.querySelectorAll("tr");
        rows.forEach((row) => {
            let cells = row.querySelectorAll("th, td");
            let rowData = Array.from(cells).map(cell => cell.innerText.replace(/\n/g, " "));
            ws_data.push(rowData);
        });

        if (ws_data.length > 0) ws_data.push([]); // Adds a blank row only if there's previous data.
    });

    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Report");

    let filename = `Laundry_Report_${new Date().toISOString().slice(0, 10)}.xlsx`;
    XLSX.writeFile(wb, filename);
}


function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
    const pageHeight = doc.internal.pageSize.height;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("ELS Washing Process", 10, 15);

    doc.setFontSize(10);
    doc.setFont("helvetica", "normal");
    doc.text("Generated on: " + new Date().toLocaleString(), 10, 25);

    let yPosition = 35;
    const leftX = 10, rightX = 150;
    let leftHeight = yPosition, rightHeight = yPosition;

    const sections = {
        "Washing Load Records": [],
        "Water Submetering": [],
        "Electric Submetering": [],
        "Detergent Dosing": [],
        "Other": []
    };

    document.querySelectorAll("table").forEach((table) => {
        const heading = table.previousElementSibling?.innerText?.toLowerCase() || "";

        if (heading.includes("washing load records")) {
            sections["Washing Load Records"].push({ table, title: heading });
        } else if (heading.includes("water submetering")) {
            sections["Water Submetering"].push({ table, title: heading });
        } else if (heading.includes("electric submetering")) {
            sections["Electric Submetering"].push({ table, title: heading });
        } else if (heading.includes("detergent dosing")) {
            sections["Detergent Dosing"].push({ table, title: heading });
        } else {
            sections["Other"].push({ table, title: heading });
        }
    });

    // Render full-width sections (default)
    function renderFullWidthTables(tablesArray, sectionTitle) {
        if (!tablesArray.length) return;

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text(sectionTitle, 10, yPosition);
        yPosition += 8;

        tablesArray.forEach(({ table, title }) => {
            let headers = [];
            let rows = [];

            table.querySelectorAll("tr").forEach((tr, i) => {
                const cells = tr.querySelectorAll("th, td");
                const rowData = Array.from(cells).map(cell => cell.innerText);

                if (i === 0) headers = rowData;
                else rows.push(rowData);
            });

            if (title) {
                doc.setFont("helvetica", "bold");
                doc.setFontSize(12);
                doc.text(title, 10, yPosition);
                yPosition += 6;
            }

            doc.autoTable({
                startY: yPosition,
                head: [headers],
                body: rows,
                theme: "grid",
                styles: { fontSize: 9, cellPadding: 2, valign: 'middle' },
                headStyles: { fillColor: [0, 102, 204], textColor: [255, 255, 255], halign: 'center' },
                margin: { left: 10, right: 10 },
                tableWidth: 'auto',
                didDrawPage: (data) => {
                    yPosition = data.cursor.y + 10;
                }
            });
        });
    }

    // Render side-by-side tables (Electric & Water)
    function renderSideBySideTables(waterTables, electricTables) {
        let leftIndex = 0, rightIndex = 0;
        const maxLen = Math.max(waterTables.length, electricTables.length);

        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("Water & Electric Submetering", 10, yPosition);
        yPosition += 8;
        leftHeight = yPosition;
        rightHeight = yPosition;

        for (let i = 0; i < maxLen; i++) {
            const positions = [
                { side: "left", x: leftX, tables: waterTables, height: leftHeight },
                { side: "right", x: rightX, tables: electricTables, height: rightHeight }
            ];

            positions.forEach(({ side, x, tables }, index) => {
                const tableObj = tables[i];
                if (!tableObj) return;

                let headers = [];
                let rows = [];

                tableObj.table.querySelectorAll("tr").forEach((tr, idx) => {
                    const cells = tr.querySelectorAll("th, td");
                    const rowData = Array.from(cells).map(cell => cell.innerText);
                    if (idx === 0) headers = rowData;
                    else rows.push(rowData);
                });

                let heightRef = (side === "left") ? leftHeight : rightHeight;

                // Check if we need new page
                if (heightRef + 40 > pageHeight) {
                    doc.addPage();
                    leftHeight = 10;
                    rightHeight = 10;
                    heightRef = (side === "left") ? leftHeight : rightHeight;
                }

                // Draw section title
                if (tableObj.title) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(12);
                    doc.text(tableObj.title, x, heightRef);
                    heightRef += 6;
                }

                doc.autoTable({
                    startY: heightRef,
                    startX: x,
                    head: [headers],
                    body: rows,
                    theme: "grid",
                    styles: { fontSize: 8, cellPadding: 2, valign: 'middle' },
                    headStyles: { fillColor: [0, 102, 204], textColor: [255, 255, 255], halign: 'center' },
                    tableWidth: 125,
                    margin: { left: x },
                    didDrawPage: (data) => {
                        if (side === "left") leftHeight = data.cursor.y + 10;
                        else rightHeight = data.cursor.y + 10;
                    }
                });
            });
        }

        yPosition = Math.max(leftHeight, rightHeight) + 10;
    }

    renderFullWidthTables(sections["Washing Load Records"], "Washing Load Records");
    renderFullWidthTables(sections["Other"], "Washing Load");
    renderSideBySideTables(sections["Electric Submetering"],sections["Water Submetering"]);
    

    // Save as PDF
    let filename = `Laundry_Report_${new Date().toISOString().slice(0, 10)}.pdf`;
    doc.save(filename);

    const pdfDataUri = doc.output('datauristring');
    window.open(pdfDataUri);
}



    </script>

<!-- Add Modal Components -->
<!-- Washing Process Modal -->
<div class="modal fade" id="washProcessModal" tabindex="-1" aria-labelledby="washProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="washProcessModalLabel">Edit Washing Process</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe src="wash_proc.html?hideNav=true" style="width: 100%; height: 80vh; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Energy Consumption Modal -->
<div class="modal fade" id="energyConsModal" tabindex="-1" aria-labelledby="energyConsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="energyConsModalLabel">Edit Energy Consumption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe src="energy_cons.html?hideNav=true" style="width: 100%; height: 80vh; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

<!-- Water Consumption Modal -->
<div class="modal fade" id="waterConsModal" tabindex="-1" aria-labelledby="waterConsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="waterConsModalLabel">Edit Water Consumption</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe src="water_cons.html?hideNav=true" style="width: 100%; height: 80vh; border: none;"></iframe>
            </div>
        </div>
    </div>
</div>

</body>
</html>